# ReMind 開發日記 - 2025/12/19

## Phase 1: 環境配置與基礎連線

### 今日目標
- [ ] 建立基礎工作流 `ReMind_V1.json`
- [ ] 測試 Discord Trigger 是否能接收訊息
- [ ] 串接 Gemini 1.5 Flash 進行初步回應

### 執行紀錄
- **20:52**：正式開始階段性開發。首先建立開發日記與工作流骨架。
- **20:53**：診斷 n8n API 連線 (`https://n8n.roy422.ggff.net`) -> **成功連線 (v2.30.1)**。
- **20:54**：成功建立工作流 `ReMind_V1_Phase1` (ID: `j3gQZnnus1n8ATWQ`)。
- **20:55**：完成節點命名規範更新 (`[T] Discord Trigger`, `[L] Parse User Info`)。
- **20:56**：進入 Phase 2。完成工作流全局更新，包含 `[AI] Manager`, `[AI] Gemini Model`, `[R] Discord Send` 與 `[M] Window Buffer Memory`。
- **20:57**：成功配置全節點連線邏輯，核心對話鏈路已就緒。
- **20:58**：修正節點名稱不一致導致的連線錯誤，目前工作流已成功更新。
- **21:12**：開始建立新的 Discord Bot 帳號，重點配置 `MESSAGE CONTENT INTENT`。
- **21:47**：使用者回報最基本聊天功能已打通（使用 Kimi 模型）。發現 `Send a message` 節點存在靜態 ID 問題。
- **22:28**：使用者發現 `n8n-discord-trigger` 社群插件的已知 Bug (Issue #39)，導致工作流發布失敗。
- **00:33**：深度優化 Phase 4 方案。引入「生產等級 (Production Grade)」穩定性修復，確保系統健壯。

### Phase 4 生產等級優化計畫
1.  **多用戶隔離強化 (Syntax Robustness)**
    - 使用 `JSON.stringify` 重構 Qdrant Filter 語法。
    - 解決 ID 格式解析錯誤問題，確保檢索 100% 準確。
2.  **事實提取脈絡優化 (Context-Aware Extraction)**
    - 調整 Extractor 分支，同時送入「用戶訊息」與「AI 回應」。
    - 解決因缺乏上下文導致事實提取遺漏的問題。
3.  **數據純淨度管理 (Noise Filtering)**
    - 在儲存前加入 IF 節點，嚴格過濾 `NONE` 或 `SKIP` 等無效內容。
    - 防止向量資料庫被閒聊內容污染。
4.  **Discord 高質感 Embeds (UI/UX Final)**
    - 正式實作 Embed JSON，包含情緒動態色彩與陪伴天數追蹤。
5.  **容錯機制 (Error Handling)**
    - 設定 `continueOnFail: true` 並加入 Error Trigger，防止背景分支失敗影響對話流程。

- **00:40**：完成深度技術審核。識別出 4 個可能導致系統崩潰或邏輯錯誤的「硬傷」，並納入 Phase 4 生產等級優化計畫。

### 2025-12-20 技術審核：關鍵修復清單
- **模型相容性**：修正 Groq 節點的模型名稱為 `llama-3.3-70b-versatile`，避免 API 404。
- **記憶過濾**：加入 **IF 節點** 攔截 "NONE/SKIP"，防止向量資料庫污染。
- **語法健壯性**：使用 `JSON.stringify` 確保多用戶 Filter 100% 正確解析。
- **提取脈絡深化**：提取事實時同時讀取「用戶訊息」+「AI 回應」，大幅提升事實捕捉率。
- **UI 高級化**：正式實作 Discord Embeds 卡片。

---
*記錄者：Antigravity*

---

# ReMind 開發日記 - 2025/12/27

## n8n 2.x 升級遷移問題排除

### 背景
將 workflow 從舊版 n8n 匯入到 **n8n@2.1.1 (Self Hosted)** 後，遇到多個節點相容性問題。n8n 2.0 為「hardening release」，包含多項 Breaking Changes。

---

### 問題 1：Qdrant Vector Store - `options` 參數不存在

**錯誤訊息**：
```
Could not find parameter "options"
```

**原因**：n8n 2.x 中 `vectorStoreQdrant` 節點的 schema 變更，`options.searchFilterJson` 已被移除。

**解決方案**：
| 項目 | 舊值 | 新值 |
|------|------|------|
| Filter 參數 | `options.searchFilterJson` | `filter` (頂層參數) |
| typeVersion | `1.3` | `1` |

```json
// 修改前
"options": {
  "searchFilterJson": "={{ JSON.stringify({...}) }}"
}

// 修改後
"filter": "={{ JSON.stringify({...}) }}"
```

---

### 問題 2：Qdrant Vector Store1 (Insert) - 空 `options` 報錯

**錯誤訊息**：同上

**解決方案**：
- 移除空的 `"options": {}`
- typeVersion 從 `1.3` 改為 `1`

---

### 問題 3：Default Data Loader - `options.metadata` 參數結構錯誤

**錯誤訊息**：
```
In or underneath Parameter: Options
```

**解決方案**：
- 將 `options.metadata` 移到頂層 `metadata`

---

### 問題 4：Default Data Loader - 缺少 Text Splitter 子節點

**錯誤訊息**：
```
A Text Splitter sub-node must be connected and enabled
```

**解決方案**：
新增 `Recursive Character Text Splitter` 節點並連接到 Default Data Loader：

```json
{
  "parameters": {
    "chunkSize": 500,
    "chunkOverlap": 50
  },
  "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
  "typeVersion": 1,
  "name": "Recursive Character Text Splitter"
}
```

---

### 問題 5：Default Data Loader - `jsonData` 參數不存在

**錯誤訊息**：
```
Could not find parameter "jsonData"
connect "Default Data Loader" to "記憶區"
```

**原因**：n8n 2.x 完全重構了 Default Data Loader 的參數結構。

**解決方案**：
| 舊參數 | 新參數 |
|--------|--------|
| `jsonMode: "expressionData"` | `dataType: "json"` + `mode: "defineBelow"` |
| `jsonData` | `data` |
| - | `textSplittingMode: "custom"` |
| typeVersion: `1` | typeVersion: `1.1` |

```json
// 修改前
{
  "jsonMode": "expressionData",
  "jsonData": "={{ $node[\"記憶區\"].json.output }}"
}

// 修改後
{
  "textSplittingMode": "custom",
  "dataType": "json",
  "mode": "defineBelow",
  "data": "={{ $node[\"過濾無效事實\"].json.output }}"
}
```

---

### 總結：n8n 2.x Langchain 節點遷移檢查清單

| 節點類型 | 需要檢查的項目 |
|----------|----------------|
| `vectorStoreQdrant` | 移除 `options` wrapper，Filter 改為頂層 |
| `documentDefaultDataLoader` | 參數重構：`jsonMode` → `dataType`+`mode`，`jsonData` → `data` |
| Document Loaders | 必須連接 Text Splitter 子節點 |
| 所有 Langchain 節點 | 檢查 typeVersion 是否與 n8n 版本相容 |

---

### 待測試項目
- [ ] 完整對話流程測試
- [ ] 事實提取存入 Qdrant 測試
- [ ] 多用戶記憶隔離測試

---
*記錄者：Antigravity*
