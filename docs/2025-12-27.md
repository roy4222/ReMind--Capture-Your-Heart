# ReMind n8n Workflow 參數記錄

> **最後更新**：2025/12/27 23:47  
> **n8n 版本**：2.1.4 (Self Hosted)  
> **用途**：避免每次匯入都要重新連接 credentials

---

## 📋 Credentials 對照表

| 節點名稱 | Credential 類型 | Credential ID | Credential 名稱 |
|----------|-----------------|---------------|-----------------|
| Discord Trigger | discordBotTriggerApi | `7n6KvU4hofCceq2R` | Discord Bot Trigger account 2 |
| Create DM Channel | discordBotApi | `wxRySyeiFf55ZbGv` | Discord Bot account 2 |
| Send Embed Message | discordBotApi | `wxRySyeiFf55ZbGv` | Discord Bot account 2 |
| Groq Chat Model | groqApi | `FARjFPoRIFiy1B5V` | Groq account |
| Groq Chat Model1 | groqApi | `FARjFPoRIFiy1B5V` | Groq account |
| Qdrant Vector Store | qdrantApi | `LCLCgPJF3rJJfvSo` | QdrantApi account |
| Qdrant Vector Store1 | qdrantApi | `LCLCgPJF3rJJfvSo` | QdrantApi account |
| Embeddings Cohere | cohereApi | `QlWUpsH73OwC54JW` | CohereApi account |
| Embeddings Cohere1 | cohereApi | `QlWUpsH73OwC54JW` | CohereApi account |

---

## ⚙️ 節點參數設定

### Groq Chat Model (回應區用)
```json
{
  "model": "openai/gpt-oss-120b",
  "options": {}
}
```

### Groq Chat Model1 (記憶區用)
```json
{
  "model": "openai/gpt-oss-120b",
  "options": {}
}
```

### Qdrant Vector Store (retrieve-as-tool)
```json
{
  "mode": "retrieve-as-tool",
  "toolName": "n8n_dc_bot",
  "toolDescription": "Use this tool to retrieve the user's past conversations and personal facts. Essential for providing personalized responses.",
  "qdrantCollection": {
    "value": "n8n_dc_bot",
    "mode": "list"
  },
  "options": {}
}
```

### Qdrant Vector Store1 (insert)
```json
{
  "mode": "insert",
  "qdrantCollection": {
    "value": "n8n_dc_bot",
    "mode": "list"
  },
  "options": {}
}
```

### Embeddings Cohere / Cohere1
```json
{
  "modelName": "embed-multilingual-v3.0"
}
```

### Default Data Loader
```json
{
  "textSplittingMode": "custom",
  "options": {}
}
```

### Recursive Character Text Splitter
```json
{
  "chunkSize": 500,
  "chunkOverlap": 50,
  "options": {}
}
```

---

## 🔗 節點連接關係

```
Discord Trigger
    ↓
回應區 (AI Agent)
    ├─→ 記憶區 (AI Agent) → 過濾無效事實 → Qdrant Vector Store1
    │                                         ↑
    │                              Default Data Loader
    │                                         ↑
    │                         Recursive Character Text Splitter
    │                                         ↑
    │                              Embeddings Cohere1
    │
    └─→ Create DM Channel → Send Embed Message
```

**回應區 子節點**：
- Simple Memory (ai_memory)
- Qdrant Vector Store (ai_tool)
- Embeddings Cohere (ai_embedding → Qdrant)
- Groq Chat Model (ai_languageModel)

**記憶區 子節點**：
- Groq Chat Model1 (ai_languageModel)

---

## 📍 節點 ID 對照

| 節點名稱 | Node ID |
|----------|---------|
| Groq Chat Model | `c4e57835-815c-434a-b1dc-52c91c844d7d` |
| Discord Trigger | `bdd3621c-4d34-4ca8-ad3c-57ba2f8ab2ec` |
| Create DM Channel | `ce077e8f-f604-4eb4-9d5a-27f6feaadad5` |
| Send Embed Message | `2c9d743d-b8a9-476d-97ea-9affbeca7938` |
| Simple Memory | `4bfc9212-1329-4654-a626-a8d70e14cd8c` |
| Qdrant Vector Store | `13aae60e-e856-4e81-9c4b-4af61d488c2e` |
| Embeddings Cohere | `88e70d4a-d2cc-445e-85f6-6f3aefd7817f` |
| Groq Chat Model1 | `b5fc1c8b-6d24-4271-9d14-193683525a50` |
| 記憶區 | `eacdd784-7208-4f53-98ad-d5e1d2ffb46e` |
| 回應區 | `e26501a6-364b-4792-8b1f-bfa2538fac90` |
| Qdrant Vector Store1 | `61d2de2b-9588-470f-9982-a1ed19d576c4` |
| Embeddings Cohere1 | `98a7b761-d6b5-4fc4-a820-983949c7c03e` |
| Default Data Loader | `79752d09-14ef-41e7-8657-52045f2c61a3` |
| 過濾無效事實 | `12d04615-7f38-419e-9b06-544b008f2553` |
| Recursive Character Text Splitter | `55193f44-9304-4780-b0a6-1b6e6e02f9c2` |

---

## 🏷️ Instance ID
```
4eea74fcd0c7c87e2f0e194ba832750e16814ee34742b77ac44f1339c7f71313
```

---

## 📝 2025/12/28 00:25 更新記錄

### ✅ 今晚完成的修改

| # | 項目 | 狀態 |
|---|------|------|
| 1 | n8n 2.x 相容性修復 (問題 1-6) | ✅ 完成 |
| 2 | Discord Embed 改用 HTTP Request | ✅ 完成 |
| 3 | Function 語法過濾 (正則表達式) | ✅ 完成 |
| 4 | 模型切換 → `openai/gpt-oss-120b` | ✅ 完成 |
| 5 | 用戶隔離: Qdrant filter (user_id) | ✅ 完成 |
| 6 | 用戶隔離: Default Data Loader metadata | ✅ 完成 |
| 7 | Discord Rate Limit 修復 | ✅ 完成 |

### 🔄 更新後的參數

**Qdrant Vector Store** (新增 filter):
```json
{
  "filter": "={{ JSON.stringify({ must: [{ key: 'user_id', match: { value: $('Discord Trigger').first().json.authorId.toString() }}] }) }}"
}
```

**Default Data Loader** (新增 data + metadata):
```json
{
  "dataType": "json",
  "mode": "defineBelow",
  "data": "={{ { text: $json.output, metadata: { user_id: $('Discord Trigger').first().json.authorId.toString() } } }}"
}
```

**Send Embed Message URL** (避免 Rate Limit):
```
$('Discord Trigger').first().json.channelId  // 不再經過 Create DM Channel
```

### 🔗 更新後的連接關係

```
Discord Trigger
    ↓
回應區 (AI Agent)
    ├─→ 記憶區 → 過濾無效事實 → Qdrant Vector Store1
    │                              ↑
    │                    Default Data Loader (含 user_id)
    │
    └─→ Send Embed Message (直接用 Trigger channelId)
```

> ⚠️ `Create DM Channel` 節點已不再使用

---

## 📋 待完成項目

- [ ] 測試深度記憶提取
- [ ] 測試多用戶記憶隔離 (需要兩個 Discord 帳號)
- [ ] 更新開發日記 (2025-12-19-dev-log.md)
- [ ] 如果 tool calling 仍不穩定 → 執行方案 B (架構改造)

---

*記錄者：Antigravity*
